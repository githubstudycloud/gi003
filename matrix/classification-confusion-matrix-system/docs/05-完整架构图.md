# ç³»ç»Ÿæ¶æ„ä¸æµç¨‹å›¾

## ä¸€ã€ç³»ç»Ÿæ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚ Frontend"
        A1[Vue 3 åº”ç”¨]
        A2[Element Plus UI]
        A3[Axios HTTPå®¢æˆ·ç«¯]
        A1 --> A2
        A1 --> A3
    end

    subgraph "åç«¯å±‚ Backend"
        B1[Spring Bootåº”ç”¨]
        B2[Controllerå±‚<br/>REST API]
        B3[Serviceå±‚<br/>ä¸šåŠ¡é€»è¾‘]
        B4[DAOå±‚<br/>MyBatis Mapper]
        B5[Excelå¯¼å‡ºæœåŠ¡<br/>Apache POI]

        B1 --> B2
        B2 --> B3
        B3 --> B4
        B3 --> B5
    end

    subgraph "æ•°æ®å±‚ Database"
        C1[(MySQL 8.0)]
        C2[classification_record<br/>åˆ†ç±»è®°å½•è¡¨]
        C3[test_case<br/>ç”¨ä¾‹è¡¨]
        C4[scenario<br/>åœºæ™¯è¡¨]
        C5[vertical_category<br/>å‚ç±»è¡¨]
        C6[factor<br/>å› å­è¡¨]
        C7[factor_value<br/>å› å­å€¼è¡¨]

        C1 --> C2
        C1 --> C3
        C1 --> C4
        C1 --> C5
        C1 --> C6
        C1 --> C7
    end

    A3 -->|HTTP/JSON| B2
    B4 --> C1
    B5 -.->|ç”ŸæˆExcelæ–‡ä»¶| A3

    style A1 fill:#409EFF,color:#fff
    style B1 fill:#67C23A,color:#fff
    style C1 fill:#E6A23C,color:#fff
```

---

## äºŒã€æ•°æ®æµè½¬æµç¨‹

### 2.1 æŸ¥è¯¢æ··æ·†çŸ©é˜µæµç¨‹

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant UI as å‰ç«¯é¡µé¢
    participant Filter as ç­›é€‰ç»„ä»¶
    participant API as APIæ¥å£
    participant Controller as Controller
    participant Service as Service
    participant Mapper as MyBatis
    participant DB as æ•°æ®åº“

    User->>UI: è®¿é—®é¡µé¢
    UI->>Filter: åŠ è½½ç­›é€‰é€‰é¡¹
    Filter->>API: GET /filter-options
    API->>Controller: getFilterOptions()
    Controller->>Service: getFilterOptions()
    Service->>Mapper: æŸ¥è¯¢ç”¨ä¾‹/åœºæ™¯/å‚ç±»/å› å­
    Mapper->>DB: SELECT * FROM test_case...
    DB-->>Mapper: è¿”å›é€‰é¡¹æ•°æ®
    Mapper-->>Service: List<TestCase>...
    Service-->>Controller: FilterOptions
    Controller-->>API: JSONå“åº”
    API-->>Filter: ç­›é€‰é€‰é¡¹æ•°æ®
    Filter-->>UI: æ¸²æŸ“ä¸‹æ‹‰æ¡†

    User->>Filter: é€‰æ‹©ç­›é€‰æ¡ä»¶
    User->>Filter: ç‚¹å‡»"æŸ¥è¯¢"æŒ‰é’®
    Filter->>API: POST /query<br/>{primaryCategory, testCaseId...}
    API->>Controller: queryMatrix(request)
    Controller->>Service: generateMatrix(request)

    Note over Service: å¼€å§‹ç”Ÿæˆæ··æ·†çŸ©é˜µ

    Service->>Mapper: queryMatrixData(request)
    Mapper->>DB: SELECT expected_value, actual_value, COUNT(*)<br/>FROM classification_record<br/>WHERE ... GROUP BY ...
    DB-->>Mapper: èšåˆç»“æœ
    Mapper-->>Service: List<Map> åŸå§‹æ•°æ®

    Note over Service: å¤„ç†æ•°æ®

    Service->>Service: 1. åˆå§‹åŒ–16x16çŸ©é˜µ
    Service->>Service: 2. å¡«å……çŸ©é˜µæ•°æ®
    Service->>Service: 3. è®¡ç®—æ¯è¡Œå¬å›ç‡
    Service->>Service: 4. è®¡ç®—æ¯åˆ—ç²¾å‡†ç‡
    Service->>Service: 5. è®¡ç®—æ€»å‡†ç¡®ç‡

    Service-->>Controller: MatrixResponse
    Controller-->>API: JSONå“åº”
    API-->>UI: çŸ©é˜µæ•°æ®

    UI->>UI: æ›´æ–°ç»Ÿè®¡å¡ç‰‡
    UI->>UI: æ¸²æŸ“æ··æ·†çŸ©é˜µè¡¨æ ¼

    UI-->>User: æ˜¾ç¤ºç»“æœ
```

---

### 2.2 å•å…ƒæ ¼è¯¦æƒ…æŸ¥è¯¢æµç¨‹

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant Table as çŸ©é˜µè¡¨æ ¼
    participant Modal as è¯¦æƒ…å¼¹çª—
    participant API as APIæ¥å£
    participant Service as Service
    participant DB as æ•°æ®åº“

    User->>Table: ç‚¹å‡»å•å…ƒæ ¼ (å®é™…5, é¢„æµ‹3)
    Table->>Modal: æ‰“å¼€å¼¹çª—<br/>cellClick(5, 3, 10)
    Modal->>API: POST /cell-detail<br/>{expectedValue: 5, actualValue: 3}
    API->>Service: getCellDetail(request, 5, 3)
    Service->>DB: SELECT *<br/>FROM classification_record<br/>WHERE expected_value=5<br/>AND actual_value=3<br/>LIMIT 1000
    DB-->>Service: List<ClassificationRecord>
    Service-->>API: MatrixCellDetail<br/>{count: 10, records: [...]}
    API-->>Modal: JSONæ•°æ®
    Modal->>Modal: æ¸²æŸ“è¯¦ç»†è®°å½•è¡¨æ ¼
    Modal-->>User: æ˜¾ç¤ºè¯¦ç»†æ•°æ®
```

---

### 2.3 Excelå¯¼å‡ºæµç¨‹

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant Filter as ç­›é€‰ç»„ä»¶
    participant API as APIæ¥å£
    participant Service as Service
    participant POI as Apache POI
    participant Browser as æµè§ˆå™¨

    User->>Filter: ç‚¹å‡»"å¯¼å‡ºExcel"æŒ‰é’®
    Filter->>API: POST /export<br/>{ç­›é€‰æ¡ä»¶}
    API->>Service: exportToExcel(matrixData, outputStream)

    Note over Service,POI: ç”ŸæˆExcelæ–‡ä»¶

    Service->>Service: generateMatrix(request)
    Service->>POI: åˆ›å»ºWorkbook
    POI->>POI: åˆ›å»ºSheet("æ··æ·†çŸ©é˜µ")
    POI->>POI: å†™å…¥æ ‡é¢˜è¡Œ
    POI->>POI: å†™å…¥è¡¨å¤´
    POI->>POI: å†™å…¥16x16çŸ©é˜µæ•°æ®
    POI->>POI: è®¾ç½®å•å…ƒæ ¼æ ·å¼<br/>(å¯¹è§’çº¿ç»¿è‰²,å…¶ä»–æ©™è‰²)
    POI->>POI: å†™å…¥SUMè¡Œ
    POI->>POI: å†™å…¥ç²¾å‡†ç‡è¡Œ
    POI-->>Service: Workbookå¯¹è±¡

    Service->>Service: workbook.write(outputStream)
    Service-->>API: æ–‡ä»¶æµ(Blob)

    API-->>Browser: Content-Type: application/vnd...xlsx<br/>Content-Disposition: attachment
    Browser->>Browser: è§¦å‘æ–‡ä»¶ä¸‹è½½
    Browser-->>User: ä¸‹è½½ confusion_matrix.xlsx
```

---

## ä¸‰ã€å‰ç«¯ç»„ä»¶æ¶æ„

```mermaid
graph TD
    A[App.vue<br/>æ ¹ç»„ä»¶] --> B[ConfusionMatrixView.vue<br/>ä¸»é¡µé¢]

    B --> C[FilterPanel.vue<br/>ç­›é€‰é¢æ¿]
    B --> D[StatsCards.vue<br/>ç»Ÿè®¡å¡ç‰‡]
    B --> E[MatrixTable.vue<br/>æ··æ·†çŸ©é˜µè¡¨æ ¼]
    B --> F[CellDetailModal.vue<br/>è¯¦æƒ…å¼¹çª—]

    C --> G[confusionMatrixApi<br/>APIå°è£…]
    E --> G
    F --> G

    G --> H[Axios HTTPå®¢æˆ·ç«¯]

    style A fill:#409EFF,color:#fff
    style B fill:#67C23A,color:#fff
    style C fill:#E6A23C,color:#fff
    style D fill:#E6A23C,color:#fff
    style E fill:#E6A23C,color:#fff
    style F fill:#E6A23C,color:#fff
```

---

## å››ã€åç«¯åˆ†å±‚æ¶æ„

```mermaid
graph LR
    subgraph "Controllerå±‚"
        A1[ConfusionMatrixController]
        A1 --> A2["/api/confusion-matrix/query"]
        A1 --> A3["/api/confusion-matrix/cell-detail"]
        A1 --> A4["/api/confusion-matrix/export"]
        A1 --> A5["/api/confusion-matrix/filter-options"]
    end

    subgraph "Serviceå±‚"
        B1[ConfusionMatrixServiceæ¥å£]
        B2[ConfusionMatrixServiceImplå®ç°]
        B1 --> B2
    end

    subgraph "DAOå±‚"
        C1[ClassificationRecordMapperæ¥å£]
        C2[ClassificationRecordMapper.xml]
        C1 --> C2
    end

    subgraph "å®ä½“å±‚"
        D1[ClassificationRecord]
        D2[TestCase/Scenario...]
        D3[QueryRequest/MatrixResponse DTO]
    end

    A1 --> B1
    B2 --> C1
    C2 --> E[(MySQL)]

    style A1 fill:#409EFF,color:#fff
    style B2 fill:#67C23A,color:#fff
    style C1 fill:#E6A23C,color:#fff
```

---

## äº”ã€æ•°æ®åº“ERå›¾

```mermaid
erDiagram
    CLASSIFICATION_RECORD {
        bigint id PK
        varchar primary_category
        varchar secondary_category
        tinyint expected_value
        tinyint actual_value
        varchar status
        bigint test_case_id FK
        bigint scenario_id FK
        bigint vertical_category_id FK
        bigint factor_id FK
        bigint factor_value_id FK
        timestamp create_time
    }

    TEST_CASE {
        bigint id PK
        varchar name
        varchar code UK
        varchar description
    }

    SCENARIO {
        bigint id PK
        varchar name
        varchar code UK
        varchar description
    }

    VERTICAL_CATEGORY {
        bigint id PK
        varchar name
        varchar code UK
        bigint parent_id FK
    }

    FACTOR {
        bigint id PK
        varchar name
        varchar code UK
        varchar type
    }

    FACTOR_VALUE {
        bigint id PK
        bigint factor_id FK
        varchar value
        varchar display_name
    }

    CLASSIFICATION_RECORD }o--|| TEST_CASE : "belongs to"
    CLASSIFICATION_RECORD }o--|| SCENARIO : "belongs to"
    CLASSIFICATION_RECORD }o--|| VERTICAL_CATEGORY : "belongs to"
    CLASSIFICATION_RECORD }o--|| FACTOR : "related to"
    CLASSIFICATION_RECORD }o--|| FACTOR_VALUE : "uses"
    FACTOR ||--|{ FACTOR_VALUE : "has many"
    VERTICAL_CATEGORY ||--o{ VERTICAL_CATEGORY : "parent-child"
```

---

## å…­ã€æ··æ·†çŸ©é˜µè®¡ç®—é€»è¾‘

```mermaid
flowchart TD
    Start([å¼€å§‹]) --> Input[æ¥æ”¶ç­›é€‰æ¡ä»¶<br/>QueryRequest]
    Input --> Query["æ‰§è¡ŒSQLèšåˆæŸ¥è¯¢<br/>GROUP BY expected_value, actual_value"]
    Query --> Init["åˆå§‹åŒ–16x16çŸ©é˜µ<br/>matrix = new Integer[16][16]"]

    Init --> Fill{éå†æŸ¥è¯¢ç»“æœ}
    Fill -->|æ¯æ¡è®°å½•| SetCell["matrix[expected][actual] = count"]
    SetCell --> Fill

    Fill -->|ç»“æŸ| CalcRow{"è®¡ç®—è¡Œç»Ÿè®¡<br/>for i=0 to 15"}
    CalcRow -->|æ¯è¡Œ| RowSum["rowSum = Î£ matrix[i][j]"]
    RowSum --> Recall["recallRate = matrix[i][i] / rowSum"]
    Recall --> CalcRow

    CalcRow -->|ç»“æŸ| CalcCol{"è®¡ç®—åˆ—ç»Ÿè®¡<br/>for j=0 to 15"}
    CalcCol -->|æ¯åˆ—| ColSum["colSum = Î£ matrix[i][j]"]
    ColSum --> Precision["precisionRate = matrix[j][j] / colSum"]
    Precision --> CalcCol

    CalcCol -->|ç»“æŸ| Total["totalCount = Î£ Î£ matrix[i][j]"]
    Total --> Correct["correctCount = Î£ matrix[i][i]"]
    Correct --> Accuracy[accuracy = correctCount / totalCount]

    Accuracy --> Return[è¿”å›MatrixResponse]
    Return --> End([ç»“æŸ])

    style Start fill:#67C23A,color:#fff
    style End fill:#F56C6C,color:#fff
    style Return fill:#409EFF,color:#fff
```

---

## ä¸ƒã€å¬å›ç‡ä¸ç²¾å‡†ç‡è®¡ç®—å…¬å¼

### 7.1 å¬å›ç‡ (Recall) - è¡Œç»Ÿè®¡

å¯¹äºå®é™…æ ‡ç­¾ `i`:

```
å¬å›ç‡(i) = æ­£ç¡®é¢„æµ‹æ•° / å®é™…æ€»æ•°
         = matrix[i][i] / Î£(matrix[i][j]), j=0..15
```

**ç¤ºä¾‹**:
- å®é™…ä¸º5çš„æ ·æœ¬æœ‰100ä¸ª
- å…¶ä¸­80ä¸ªè¢«æ­£ç¡®é¢„æµ‹ä¸º5
- å¬å›ç‡ = 80 / 100 = 80%

### 7.2 ç²¾å‡†ç‡ (Precision) - åˆ—ç»Ÿè®¡

å¯¹äºé¢„æµ‹æ ‡ç­¾ `j`:

```
ç²¾å‡†ç‡(j) = æ­£ç¡®é¢„æµ‹æ•° / é¢„æµ‹æ€»æ•°
         = matrix[j][j] / Î£(matrix[i][j]), i=0..15
```

**ç¤ºä¾‹**:
- é¢„æµ‹ä¸º5çš„æ ·æœ¬æœ‰120ä¸ª
- å…¶ä¸­80ä¸ªå®é™…ç¡®å®æ˜¯5
- ç²¾å‡†ç‡ = 80 / 120 = 66.7%

### 7.3 æ€»å‡†ç¡®ç‡ (Accuracy)

```
æ€»å‡†ç¡®ç‡ = æ‰€æœ‰æ­£ç¡®é¢„æµ‹æ•° / æ€»æ ·æœ¬æ•°
        = Î£(matrix[i][i]) / Î£ Î£(matrix[i][j])
```

---

## å…«ã€æ··æ·†çŸ©é˜µå¯è§†åŒ–ç¤ºä¾‹

```
ä¸€çº§åˆ†ç±»: æœè£…  |  äºŒçº§åˆ†ç±»: ä¸Šè¡£

              é¢„æµ‹0  é¢„æµ‹1  é¢„æµ‹2  ...  é¢„æµ‹15  â”‚ SUM   å¬å›ç‡
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å®é™…0        45      3      1    ...    0     â”‚  50    90%   âœ…
å®é™…1         2     38      0    ...    0     â”‚  40    95%   âœ…
å®é™…2         1      0     35    ...    0     â”‚  38    92%   âœ…
...         ...    ...    ...    ...   ...    â”‚ ...    ...
å®é™…15        0      0      1    ...   28     â”‚  30    93%   âœ…
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SUM          52     45     42    ...   30     â”‚ 500
ç²¾å‡†ç‡       86%    84%    83%   ...   93%    â”‚ æ€»å‡†ç¡®ç‡: 92%
            âœ…     âœ…     âœ…          âœ…
```

**é¢œè‰²ç¼–ç **:
- ğŸŸ¢ **å¯¹è§’çº¿** (å®é™…=é¢„æµ‹): ç»¿è‰²èƒŒæ™¯ - é¢„æµ‹æ­£ç¡®
- ğŸŸ  **éå¯¹è§’çº¿**: æ©™è‰²èƒŒæ™¯ - é¢„æµ‹é”™è¯¯
- âšª **0å€¼**: ç°è‰²èƒŒæ™¯ - æ— æ•°æ®

---

## ä¹ã€ç³»ç»Ÿéƒ¨ç½²æ¶æ„

```mermaid
graph TB
    subgraph "ç”Ÿäº§ç¯å¢ƒ"
        subgraph "å‰ç«¯æœåŠ¡å™¨"
            A1[Nginx<br/>ç«¯å£: 80/443]
            A2[Vueé™æ€æ–‡ä»¶]
            A1 --> A2
        end

        subgraph "åç«¯æœåŠ¡å™¨"
            B1[Tomcat/Spring Boot<br/>ç«¯å£: 8080]
            B2[JVM<br/>Heap: 2GB]
            B1 --> B2
        end

        subgraph "æ•°æ®åº“æœåŠ¡å™¨"
            C1[MySQL 8.0<br/>ç«¯å£: 3306]
            C2[ä¸»ä»å¤åˆ¶]
            C1 --> C2
        end

        subgraph "ç¼“å­˜æœåŠ¡å™¨(å¯é€‰)"
            D1[Redis<br/>ç«¯å£: 6379]
        end
    end

    A1 -->|åå‘ä»£ç†/api/*| B1
    B1 --> C1
    B1 -.->|çƒ­ç‚¹æ•°æ®ç¼“å­˜| D1

    style A1 fill:#409EFF,color:#fff
    style B1 fill:#67C23A,color:#fff
    style C1 fill:#E6A23C,color:#fff
    style D1 fill:#F56C6C,color:#fff
```

---

## åã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

```mermaid
graph TB
    Root[æ€§èƒ½ä¼˜åŒ–] --> A[å‰ç«¯ä¼˜åŒ–]
    Root --> B[åç«¯ä¼˜åŒ–]
    Root --> C[æ•°æ®åº“ä¼˜åŒ–]
    Root --> D[ç¼“å­˜ä¼˜åŒ–]

    A --> A1[è™šæ‹Ÿæ»šåŠ¨]
    A --> A2[æ‡’åŠ è½½]
    A --> A3[ç»„ä»¶ç¼“å­˜]
    A --> A4[CDNåŠ é€Ÿ]

    B --> B1[SQLç´¢å¼•ä¼˜åŒ–]
    B --> B2[æ•°æ®åº“è¿æ¥æ± ]
    B --> B3[å¼‚æ­¥å¤„ç†]
    B --> B4[åˆ†é¡µæŸ¥è¯¢]

    C --> C1[é¢„èšåˆè¡¨]
    C --> C2[ç‰©åŒ–è§†å›¾]
    C --> C3[åˆ†åº“åˆ†è¡¨]
    C --> C4[è¯»å†™åˆ†ç¦»]

    D --> D1[Redisç¼“å­˜]
    D --> D2[æœ¬åœ°ç¼“å­˜]
    D --> D3[ç¼“å­˜é¢„çƒ­]
    D --> D4[è¿‡æœŸç­–ç•¥]

    style Root fill:#409EFF,color:#fff
    style A fill:#67C23A,color:#fff
    style B fill:#E6A23C,color:#fff
    style C fill:#F56C6C,color:#fff
    style D fill:#909399,color:#fff
```

---

## åä¸€ã€å¼€å‘ä¸éƒ¨ç½²æµç¨‹

```mermaid
graph LR
    A[åˆå§‹åŒ–é¡¹ç›®] --> B[æ•°æ®åº“è¡¨è®¾è®¡]
    B --> C[åç«¯å¼€å‘]
    B --> D[å‰ç«¯å¼€å‘]

    C --> C1[å®ç°Entity]
    C1 --> C2[å®ç°Mapper]
    C2 --> C3[å®ç°Service]
    C3 --> C4[å®ç°Controller]
    C4 --> C5[ç¼–å†™å•å…ƒæµ‹è¯•]

    D --> D1[åˆ›å»ºVueé¡¹ç›®]
    D1 --> D2[å®ç°APIå°è£…]
    D2 --> D3[å®ç°ç»„ä»¶]
    D3 --> D4[é›†æˆElement Plus]

    C5 --> E[åç«¯v1.0]
    D4 --> F[å‰ç«¯v1.0]

    E --> G[é›†æˆæµ‹è¯•]
    F --> G
    G --> H[ç”Ÿäº§éƒ¨ç½² v1.0-release]

    style A fill:#67C23A,color:#fff
    style B fill:#409EFF,color:#fff
    style C fill:#E6A23C,color:#fff
    style D fill:#E6A23C,color:#fff
    style E fill:#909399,color:#fff
    style F fill:#909399,color:#fff
    style G fill:#F56C6C,color:#fff
    style H fill:#F56C6C,color:#fff
```

---

**æ€»ç»“**: æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªå…¸å‹çš„**å‰åç«¯åˆ†ç¦»æ¶æ„**,é‡‡ç”¨**Vue 3 + Spring Boot + MySQL**æŠ€æœ¯æ ˆ,æ ¸å¿ƒåŠŸèƒ½æ˜¯é€šè¿‡**æ··æ·†çŸ©é˜µ**å¯è§†åŒ–åˆ†ç±»æ¨¡å‹çš„é¢„æµ‹æ•ˆæœ,å¹¶æä¾›çµæ´»çš„å¤šç»´åº¦ç­›é€‰å’ŒExcelå¯¼å‡ºåŠŸèƒ½ã€‚
