<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ··æ·†çŸ©é˜µç»Ÿè®¡æŠ¥è¡¨ - æ¼”ç¤ºåŸå‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        /* ç­›é€‰åŒºåŸŸ */
        .filter-section {
            background: #fafafa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .filter-item label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #409EFF;
            color: white;
        }

        .btn-primary:hover {
            background: #66b1ff;
        }

        .btn-success {
            background: #67C23A;
            color: white;
        }

        .btn-success:hover {
            background: #85ce61;
        }

        .btn-info {
            background: #909399;
            color: white;
        }

        .btn-info:hover {
            background: #a6a9ad;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* æ··æ·†çŸ©é˜µè¡¨æ ¼ */
        .matrix-wrapper {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 50px;
        }

        .matrix-table th {
            background: #409EFF;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .matrix-table th.row-header {
            background: #67C23A;
            text-align: left;
            padding-left: 15px;
        }

        .matrix-table td.row-label {
            background: #f0f9ff;
            font-weight: 600;
            text-align: left;
            padding-left: 15px;
        }

        /* å¯¹è§’çº¿(é¢„æµ‹æ­£ç¡®) - ç»¿è‰² */
        .cell-correct {
            background: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }

        /* éå¯¹è§’çº¿(é¢„æµ‹é”™è¯¯) - æ©™è‰² */
        .cell-error {
            background: #fff3cd;
            color: #856404;
        }

        /* ç©ºå€¼ */
        .cell-zero {
            background: #f8f9fa;
            color: #aaa;
        }

        /* ç»Ÿè®¡åˆ— */
        .sum-column {
            background: #e7f3ff !important;
            font-weight: bold;
        }

        .recall-column {
            background: #e8f5e9 !important;
            font-weight: bold;
        }

        .recall-high {
            color: #2e7d32;
        }

        .recall-medium {
            color: #f57c00;
        }

        .recall-low {
            color: #c62828;
        }

        /* ç»Ÿè®¡è¡Œ */
        .sum-row td {
            background: #e7f3ff !important;
            font-weight: bold;
        }

        .precision-row td {
            background: #e8f5e9 !important;
            font-weight: bold;
        }

        /* å¯ç‚¹å‡»å•å…ƒæ ¼ */
        .cell-clickable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .cell-clickable:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 80%;
            max-width: 1000px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .detail-table th,
        .detail-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .detail-table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .badge-pass {
            background: #67C23A;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .badge-fail {
            background: #F56C6C;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ åˆ†ç±»é¢„æµ‹æ··æ·†çŸ©é˜µç»Ÿè®¡æŠ¥è¡¨</h1>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <label>ä¸€çº§åˆ†ç±»</label>
                    <select id="primaryCategory">
                        <option value="">å…¨éƒ¨</option>
                        <option value="æœè£…" selected>æœè£…</option>
                        <option value="ç”µå­">ç”µå­</option>
                        <option value="é£Ÿå“">é£Ÿå“</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>äºŒçº§åˆ†ç±»</label>
                    <select id="secondaryCategory">
                        <option value="">å…¨éƒ¨</option>
                        <option value="ä¸Šè¡£" selected>ä¸Šè¡£</option>
                        <option value="è£¤å­">è£¤å­</option>
                        <option value="é‹å­">é‹å­</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>æµ‹è¯•ç”¨ä¾‹</label>
                    <select id="testCase">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">æ˜¥å­£æ–°å“æµ‹è¯•</option>
                        <option value="2">ä¿ƒé”€æ´»åŠ¨æµ‹è¯•</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>åº”ç”¨åœºæ™¯</label>
                    <select id="scenario">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">ç”µå•†æ¨è</option>
                        <option value="2">æœç´¢ç»“æœ</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-item">
                    <label>å‚ç±»</label>
                    <select id="verticalCategory">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">å¥³è£…</option>
                        <option value="2">ç”·è£…</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>å› å­</label>
                    <select id="factor">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">é¢œè‰²</option>
                        <option value="2">å°ºç </option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>å› å­å€¼</label>
                    <select id="factorValue">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">çº¢è‰²</option>
                        <option value="2">è“è‰²</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-primary" onclick="loadMatrix()">ğŸ” æŸ¥è¯¢</button>
                <button class="btn-success" onclick="exportExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
                <button class="btn-info" onclick="resetFilters()">ğŸ”„ é‡ç½®</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">1000</div>
                <div class="stat-label">æ€»æ ·æœ¬æ•°</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value" id="correctCount">850</div>
                <div class="stat-label">é¢„æµ‹æ­£ç¡®æ•°</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-value" id="accuracy">85.0%</div>
                <div class="stat-label">æ€»å‡†ç¡®ç‡</div>
            </div>
        </div>

        <!-- æ··æ·†çŸ©é˜µè¡¨æ ¼ -->
        <div class="matrix-wrapper">
            <table class="matrix-table" id="matrixTable">
                <!-- è¡¨æ ¼å†…å®¹ç”±JavaScriptç”Ÿæˆ -->
            </table>
        </div>
    </div>

    <!-- è¯¦ç»†æ•°æ®æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ” å•å…ƒæ ¼è¯¦ç»†æ•°æ®</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- è¯¦ç»†æ•°æ®å†…å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ•°æ® - 16x16æ··æ·†çŸ©é˜µ
        function generateMockMatrix() {
            const matrix = [];
            for (let i = 0; i < 16; i++) {
                matrix[i] = [];
                for (let j = 0; j < 16; j++) {
                    // å¯¹è§’çº¿æ•°æ®è¾ƒå¤š(é¢„æµ‹æ­£ç¡®),éå¯¹è§’çº¿æ•°æ®è¾ƒå°‘
                    if (i === j) {
                        matrix[i][j] = Math.floor(Math.random() * 50) + 30; // 30-80
                    } else {
                        matrix[i][j] = Math.floor(Math.random() * 10); // 0-10
                    }
                }
            }
            return matrix;
        }

        // è®¡ç®—å¬å›ç‡
        function calculateRecall(matrix, row) {
            let total = 0;
            let correct = matrix[row][row];
            for (let j = 0; j < 16; j++) {
                total += matrix[row][j];
            }
            return total > 0 ? (correct / total * 100).toFixed(2) : 0;
        }

        // è®¡ç®—ç²¾å‡†ç‡
        function calculatePrecision(matrix, col) {
            let total = 0;
            let correct = matrix[col][col];
            for (let i = 0; i < 16; i++) {
                total += matrix[i][col];
            }
            return total > 0 ? (correct / total * 100).toFixed(2) : 0;
        }

        // è·å–å¬å›ç‡æ ·å¼ç±»
        function getRecallClass(rate) {
            if (rate >= 90) return 'recall-high';
            if (rate >= 70) return 'recall-medium';
            return 'recall-low';
        }

        // åŠ è½½æ··æ·†çŸ©é˜µ
        function loadMatrix() {
            const matrix = generateMockMatrix();
            const table = document.getElementById('matrixTable');
            let html = '';

            // è¡¨å¤´ç¬¬ä¸€è¡Œ
            html += '<tr>';
            html += '<th class="row-header">å®é™… \\ é¢„æµ‹</th>';
            for (let i = 0; i < 16; i++) {
                html += `<th>é¢„æµ‹ä¸º${i}</th>`;
            }
            html += '<th>SUM</th>';
            html += '<th>å¬å›ç‡</th>';
            html += '</tr>';

            // æ•°æ®è¡Œ
            let totalCount = 0;
            let correctCount = 0;

            for (let i = 0; i < 16; i++) {
                html += '<tr>';
                html += `<td class="row-label">å®é™…ä¸º${i}</td>`;

                let rowSum = 0;
                for (let j = 0; j < 16; j++) {
                    const value = matrix[i][j];
                    rowSum += value;
                    totalCount += value;
                    if (i === j) correctCount += value;

                    let cellClass = 'cell-clickable ';
                    if (value === 0) {
                        cellClass += 'cell-zero';
                    } else if (i === j) {
                        cellClass += 'cell-correct';
                    } else {
                        cellClass += 'cell-error';
                    }

                    html += `<td class="${cellClass}" onclick="showDetail(${i}, ${j}, ${value})">${value}</td>`;
                }

                const recall = calculateRecall(matrix, i);
                html += `<td class="sum-column">${rowSum}</td>`;
                html += `<td class="recall-column ${getRecallClass(recall)}">${recall}%</td>`;
                html += '</tr>';
            }

            // SUMè¡Œ
            html += '<tr class="sum-row">';
            html += '<td>SUM</td>';
            for (let j = 0; j < 16; j++) {
                let colSum = 0;
                for (let i = 0; i < 16; i++) {
                    colSum += matrix[i][j];
                }
                html += `<td>${colSum}</td>`;
            }
            html += `<td>${totalCount}</td>`;
            html += '<td></td>';
            html += '</tr>';

            // ç²¾å‡†ç‡è¡Œ
            html += '<tr class="precision-row">';
            html += '<td>ç²¾å‡†ç‡</td>';
            for (let j = 0; j < 16; j++) {
                const precision = calculatePrecision(matrix, j);
                html += `<td class="${getRecallClass(precision)}">${precision}%</td>`;
            }
            const accuracy = (correctCount / totalCount * 100).toFixed(2);
            html += `<td colspan="2">æ€»å‡†ç¡®ç‡: ${accuracy}%</td>`;
            html += '</tr>';

            table.innerHTML = html;

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // æ˜¾ç¤ºè¯¦ç»†æ•°æ®
        function showDetail(expected, actual, count) {
            if (count === 0) return;

            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');

            let html = `
                <div style="margin-bottom: 20px;">
                    <p><strong>å®é™…å€¼:</strong> ${expected}</p>
                    <p><strong>é¢„æµ‹å€¼:</strong> ${actual}</p>
                    <p><strong>è®°å½•æ•°:</strong> ${count}</p>
                </div>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ä¸€çº§åˆ†ç±»</th>
                            <th>äºŒçº§åˆ†ç±»</th>
                            <th>é¢„æœŸå€¼</th>
                            <th>å®é™…å€¼</th>
                            <th>çŠ¶æ€</th>
                            <th>ç”¨ä¾‹</th>
                            <th>åœºæ™¯</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // ç”Ÿæˆæ¨¡æ‹Ÿè¯¦ç»†æ•°æ®
            for (let i = 0; i < Math.min(count, 10); i++) {
                const status = expected === actual ? 'pass' : 'fail';
                const badgeClass = status === 'pass' ? 'badge-pass' : 'badge-fail';
                html += `
                    <tr>
                        <td>${1000 + i}</td>
                        <td>æœè£…</td>
                        <td>ä¸Šè¡£</td>
                        <td>${expected}</td>
                        <td>${actual}</td>
                        <td><span class="${badgeClass}">${status.toUpperCase()}</span></td>
                        <td>æ˜¥å­£æ–°å“æµ‹è¯•</td>
                        <td>ç”µå•†æ¨è</td>
                    </tr>
                `;
            }

            if (count > 10) {
                html += `<tr><td colspan="8" style="text-align: center; color: #999;">... è¿˜æœ‰ ${count - 10} æ¡è®°å½•</td></tr>`;
            }

            html += '</tbody></table>';
            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // å¯¼å‡ºExcel
        function exportExcel() {
            alert('å¯¼å‡ºExcelåŠŸèƒ½éœ€è¦è°ƒç”¨åç«¯API:\nPOST /api/confusion-matrix/export');
            // å®é™…å®ç°:
            // fetch('/api/confusion-matrix/export', {
            //     method: 'POST',
            //     body: JSON.stringify(getFilters()),
            //     headers: {'Content-Type': 'application/json'}
            // }).then(res => res.blob()).then(blob => {
            //     const url = window.URL.createObjectURL(blob);
            //     const a = document.createElement('a');
            //     a.href = url;
            //     a.download = 'confusion_matrix.xlsx';
            //     a.click();
            // });
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('primaryCategory').value = '';
            document.getElementById('secondaryCategory').value = '';
            document.getElementById('testCase').value = '';
            document.getElementById('scenario').value = '';
            document.getElementById('verticalCategory').value = '';
            document.getElementById('factor').value = '';
            document.getElementById('factorValue').value = '';
            loadMatrix();
        }

        // è·å–ç­›é€‰æ¡ä»¶
        function getFilters() {
            return {
                primaryCategory: document.getElementById('primaryCategory').value,
                secondaryCategory: document.getElementById('secondaryCategory').value,
                testCaseId: document.getElementById('testCase').value || null,
                scenarioId: document.getElementById('scenario').value || null,
                verticalCategoryId: document.getElementById('verticalCategory').value || null,
                factorId: document.getElementById('factor').value || null,
                factorValueId: document.getElementById('factorValue').value || null
            };
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadMatrix();
        };
    </script>
</body>
</html>
