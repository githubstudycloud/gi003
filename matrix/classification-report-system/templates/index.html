<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»é¢„æµ‹ç»Ÿè®¡æŠ¥è¡¨ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }

        .filter-item select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-item select:hover {
            border-color: #667eea;
        }

        .filter-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .content {
            padding: 25px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .summary-card h4 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .matrix-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .matrix-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }

        .confusion-matrix {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 30px;
            font-size: 13px;
        }

        .confusion-matrix th,
        .confusion-matrix td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .confusion-matrix th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .confusion-matrix tr:first-child th {
            background: #764ba2;
        }

        .confusion-matrix td:first-child {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .confusion-matrix .diagonal {
            background: #d4edda !important;
            font-weight: bold;
            color: #155724;
        }

        .confusion-matrix .sum-row {
            background: #e9ecef;
            font-weight: bold;
        }

        .confusion-matrix .metric-row {
            background: #fff3cd;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
            margin-bottom: 20px;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .matrix-section {
            display: none;
        }

        .matrix-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>åˆ†ç±»é¢„æµ‹ç»Ÿè®¡æŠ¥è¡¨ç³»ç»Ÿ</h1>
            <p>æ··æ·†çŸ©é˜µåˆ†æ | å¬å›ç‡ & ç²¾å‡†ç‡ç»Ÿè®¡ | å¤šç»´åº¦ç­›é€‰</p>
        </div>

        <div class="controls">
            <div class="filter-section">
                <h3>ğŸ” æ•°æ®ç­›é€‰æ¡ä»¶</h3>
                <div class="filter-grid">
                    <div class="filter-item">
                        <label>ç”¨ä¾‹</label>
                        <select id="filter-use-case">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>åœºæ™¯</label>
                        <select id="filter-scenario">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>å‚ç±»</label>
                        <select id="filter-vertical">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>å› å­</label>
                        <select id="filter-factor">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>å› å­å€¼</label>
                        <select id="filter-factor-value">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>ä¸€çº§åˆ†ç±»</label>
                        <select id="filter-primary-category">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>äºŒçº§åˆ†ç±»</label>
                        <select id="filter-secondary-category">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="generateReport()">ğŸ“Š ç”ŸæˆæŠ¥è¡¨</button>
                <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ å¯¼å‡ºExcel</button>
                <button class="btn btn-info" onclick="generateSampleData()">ğŸ² ç”Ÿæˆç¤ºä¾‹æ•°æ®</button>
                <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ é‡ç½®ç­›é€‰</button>
            </div>
        </div>

        <div class="content">
            <div id="summary-section"></div>
            <div id="report-section"></div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–
        window.onload = function() {
            loadFilterOptions();
        };

        // åŠ è½½ç­›é€‰é€‰é¡¹
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filters/options');
                const data = await response.json();

                populateSelect('filter-use-case', data.use_cases);
                populateSelect('filter-scenario', data.scenarios);
                populateSelect('filter-vertical', data.verticals);
                populateSelect('filter-factor', data.factors);
                populateSelect('filter-factor-value', data.factor_values);
                populateSelect('filter-primary-category', data.primary_categories);
                populateSelect('filter-secondary-category', data.secondary_categories);
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">å…¨éƒ¨</option>';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
        }

        // ç”ŸæˆæŠ¥è¡¨
        async function generateReport() {
            const filters = getFilters();
            const reportSection = document.getElementById('report-section');
            reportSection.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆæŠ¥è¡¨</div>';

            try {
                const response = await fetch('/api/report/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(filters)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'ç”ŸæˆæŠ¥è¡¨å¤±è´¥');
                }

                displayReport(result.data);
            } catch (error) {
                reportSection.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
            }
        }

        function displayReport(data) {
            // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
            displaySummary(data.summary);

            // æ˜¾ç¤ºæ··æ·†çŸ©é˜µ
            const reportSection = document.getElementById('report-section');
            let html = '<div class="matrix-container">';

            // åˆ†ç±»æ ‡ç­¾é¡µ
            html += '<div class="category-tabs">';
            html += '<button class="tab active" onclick="showMatrix(\'overall\')">æ€»ä½“</button>';
            for (const category in data.by_primary_category) {
                html += `<button class="tab" onclick="showMatrix('${category}')">${category}</button>`;
            }
            html += '</div>';

            // æ€»ä½“çŸ©é˜µ
            html += '<div id="matrix-overall" class="matrix-section active">';
            html += createConfusionMatrixHTML(data.overall, 'æ€»ä½“');
            html += '</div>';

            // å„åˆ†ç±»çŸ©é˜µ
            for (const [category, matrixData] of Object.entries(data.by_primary_category)) {
                html += `<div id="matrix-${category}" class="matrix-section">`;
                html += createConfusionMatrixHTML(matrixData, `ä¸€çº§åˆ†ç±»: ${category}`);
                html += '</div>';
            }

            html += '</div>';
            reportSection.innerHTML = html;
        }

        function displaySummary(summary) {
            const summarySection = document.getElementById('summary-section');
            summarySection.innerHTML = `
                <div class="summary-cards">
                    <div class="summary-card">
                        <h4>æ€»è®°å½•æ•°</h4>
                        <div class="value">${summary.total_records}</div>
                    </div>
                    <div class="summary-card">
                        <h4>é€šè¿‡æ•° (PASS)</h4>
                        <div class="value" style="color: #28a745;">${summary.passed}</div>
                    </div>
                    <div class="summary-card">
                        <h4>å¤±è´¥æ•° (FAIL)</h4>
                        <div class="value" style="color: #dc3545;">${summary.failed}</div>
                    </div>
                    <div class="summary-card">
                        <h4>å‡†ç¡®ç‡</h4>
                        <div class="value" style="color: #667eea;">${summary.accuracy}%</div>
                    </div>
                </div>
            `;
        }

        function createConfusionMatrixHTML(matrixData, title) {
            const matrix = matrixData.matrix;
            const precision = matrixData.precision;
            const recall = matrixData.recall;
            const totalExpected = matrixData.total_expected;
            const totalActual = matrixData.total_actual;

            let html = `<h3 class="matrix-title">${title}</h3>`;
            html += '<table class="confusion-matrix">';

            // è¡¨å¤´
            html += '<tr><th>å®é™…\\é¢„æµ‹</th>';
            for (let i = 0; i < 16; i++) {
                html += `<th>é¢„æµ‹${i}</th>`;
            }
            html += '<th>SUM</th><th>å¬å›ç‡(%)</th></tr>';

            // æ•°æ®è¡Œ
            for (let i = 0; i < 16; i++) {
                html += `<tr><td>å®é™…${i}</td>`;
                for (let j = 0; j < 16; j++) {
                    const cellClass = (i === j && matrix[i][j] > 0) ? 'diagonal' : '';
                    html += `<td class="${cellClass}">${matrix[i][j]}</td>`;
                }
                html += `<td>${totalActual[i]}</td>`;
                html += `<td>${recall[i].toFixed(2)}</td>`;
                html += '</tr>';
            }

            // SUMè¡Œ
            html += '<tr class="sum-row"><td>SUM</td>';
            for (let i = 0; i < 16; i++) {
                html += `<td>${totalExpected[i]}</td>`;
            }
            html += `<td>${totalExpected.reduce((a, b) => a + b, 0)}</td><td>-</td></tr>`;

            // ç²¾å‡†ç‡è¡Œ
            html += '<tr class="metric-row"><td>ç²¾å‡†ç‡(%)</td>';
            for (let i = 0; i < 16; i++) {
                html += `<td>${precision[i].toFixed(2)}</td>`;
            }
            html += '<td>-</td><td>-</td></tr>';

            html += '</table>';
            return html;
        }

        function showMatrix(category) {
            // éšè—æ‰€æœ‰çŸ©é˜µ
            document.querySelectorAll('.matrix-section').forEach(section => {
                section.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„çŸ©é˜µ
            const sectionId = category === 'overall' ? 'matrix-overall' : `matrix-${category}`;
            document.getElementById(sectionId).classList.add('active');

            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // å¯¼å‡ºExcel
        async function exportExcel() {
            const filters = getFilters();

            try {
                const response = await fetch('/api/export/excel', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(filters)
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'å¯¼å‡ºå¤±è´¥');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `classification_report_${new Date().getTime()}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('Excelå¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // ç”Ÿæˆç¤ºä¾‹æ•°æ®
        async function generateSampleData() {
            const count = prompt('è¯·è¾“å…¥è¦ç”Ÿæˆçš„è®°å½•æ•° (é»˜è®¤200):', '200');
            if (!count) return;

            try {
                const response = await fetch('/api/data/generate-sample', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({count: parseInt(count)})
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    loadFilterOptions();
                    generateReport();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert('ç”Ÿæˆç¤ºä¾‹æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.querySelectorAll('.filter-item select').forEach(select => {
                select.value = '';
            });
        }

        // è·å–ç­›é€‰æ¡ä»¶
        function getFilters() {
            return {
                use_case: document.getElementById('filter-use-case').value || null,
                scenario: document.getElementById('filter-scenario').value || null,
                vertical: document.getElementById('filter-vertical').value || null,
                factor: document.getElementById('filter-factor').value || null,
                factor_value: document.getElementById('filter-factor-value').value || null,
                primary_category: document.getElementById('filter-primary-category').value || null,
                secondary_category: document.getElementById('filter-secondary-category').value || null
            };
        }
    </script>
</body>
</html>
